name: Tests

on:
  push:
    branches: [ main, develop, 'claude/*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy scipy matplotlib pandas statsmodels scikit-learn
        pip install pytest pytest-cov black mypy isort flake8

    - name: Install package
      run: |
        pip install -e .

    - name: Run black (code formatting check)
      run: |
        black --check seamaware tests

    - name: Run isort (import sorting check)
      run: |
        isort --check-only seamaware tests

    - name: Run mypy (type checking on strict modules)
      run: |
        mypy seamaware/core/detection.py tests/test_performance.py --python-version=3.9
      continue-on-error: true  # Gradual enforcement

    - name: Run flake8 (linting)
      run: |
        flake8 seamaware tests --max-line-length=88 --extend-ignore=E203,W503
      continue-on-error: true  # Warning only

    - name: Run unit tests
      run: |
        pytest tests/ -v --cov=seamaware --cov-report=term-missing --cov-report=xml -m "not slow"

    - name: Validate k* convergence (critical test)
      run: |
        pytest tests/test_k_star_convergence.py::test_k_star_convergence_basic -v

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

  slow-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy scipy matplotlib pandas statsmodels scikit-learn
        pip install pytest pytest-cov

    - name: Install package
      run: |
        pip install -e .

    - name: Run slow tests (including rigorous k* validation)
      run: |
        pytest tests/ -v -m "slow"
